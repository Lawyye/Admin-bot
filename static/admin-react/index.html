<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LegalBot Admin</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel –¥–ª—è JSX –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-neutral-900 text-neutral-100 min-h-screen">
  <div style="padding:20px; color:lime; font-size:20px;">
    üõ† React‚Äë–ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞! üõ†
  </div>
  <div id="root"></div>
  

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [requests, setRequests] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch("/admin/api/requests", { credentials: 'include' })
          .then(res => {
            if (res.status === 401) window.location.href = "/admin/login";
            return res.json();
          })
          .then(data => { setRequests(data); setLoading(false); });
      }, []);

      const handleUpdate = (id, status, reply, e) => {
        e.preventDefault();
        const form = new FormData();
        form.append("request_id", id);
        form.append("status", status);
        form.append("reply", reply);
        fetch("/admin/update", { method: "POST", body: form, credentials: 'include' })
          .then(() => alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"));
      };

      if (loading) return <div className="p-4 text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

      return (
        <div className="p-6">
          <header className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold">–ü–∞–Ω–µ–ª—å –∑–∞—è–≤–æ–∫</h1>
            <a href="/admin/logout" className="px-4 py-2 bg-red-600 rounded hover:bg-red-700">–í—ã–π—Ç–∏</a>
          </header>
          {requests.length === 0
            ? <p className="text-gray-400">–ù–µ—Ç –∑–∞—è–≤–æ–∫.</p>
            : requests.map(r => (
                <div key={r.id} className="bg-neutral-800 p-4 rounded mb-4">
                  <div className="flex justify-between">
                    <h2 className="text-xl">#{r.id} ‚Äî {r.name}</h2>
                    <span className="px-2 py-1 bg-blue-600 rounded text-sm">{r.status}</span>
                  </div>
                  <p className="mt-1 text-gray-300">üìû {r.phone}</p>
                  <p className="mt-2">{r.message}</p>
                  <p className="mt-2 text-xs text-gray-500">
                    {new Date(r.created_at).toLocaleString("ru-RU")}
                  </p>
                  <div className="mt-2">
                    <p className="font-medium">–î–æ–∫—É–º–µ–Ω—Ç—ã:</p>
                    {r.documents.map((d,i) => (
                      <a key={i}
                         href={`/download/${d.file_id}`}
                         className="block text-blue-400 underline text-sm"
                         target="_blank"
                         rel="noopener">
                        üìé {d.file_name}
                      </a>
                    ))}
                  </div>
                  <form
                    className="mt-4 flex gap-2"
                    onSubmit={e =>
                      handleUpdate(
                        r.id,
                        e.target.status.value,
                        e.target.reply.value,
                        e
                      )
                    }
                  >
                    <select name="status" defaultValue={r.status}
                            className="bg-neutral-700 rounded px-2">
                      <option value="new">üÜï</option>
                      <option value="in_progress">üîß</option>
                      <option value="done">‚úÖ</option>
                    </select>
                    <input name="reply" placeholder="–û—Ç–≤–µ—Ç..."
                           className="flex-1 bg-neutral-700 rounded px-2" />
                    <button type="submit"
                            className="bg-green-600 px-4 rounded hover:bg-green-700">
                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                  </form>
                </div>
              ))
          }
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
